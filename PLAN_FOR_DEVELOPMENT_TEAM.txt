
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                   ğŸ“‹ TECHNICAL PLAN FOR OPENCODE TEAM                     â•‘
â•‘           Complete Bot Fix: Handlers, Token Sanitization, Resilience      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


PROJECT OVERVIEW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Repository: tg-bot-seedbox-debrid-support
Current Status: 3 critical issues preventing functionality
Timeline: Estimated 2-3 hours to complete all fixes + testing

Issues to Fix:
  1. RealDebrid token contains hidden carriage return (\r) character
  2. Most command handlers removed - only /status works
  3. Seedbox 502 Bad Gateway errors crash bot with no retry logic


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

DETAILED REQUIREMENTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ISSUE #1: RealDebrid Token Sanitization
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Problem:
  - RD_ACCESS_TOKEN environment variable contains \r (carriage return)
  - Causes: "Invalid leading whitespace, reserved character(s), or return character(s) in header value"
  - RealDebrid API calls fail intermittently

Solution: Update bot/clients/realdebrid.py

  Requirements:
    âœ… Strip \r, \n, \t from token on initialization
    âœ… Remove leading/trailing whitespace
    âœ… Remove quotes if present
    âœ… Log sanitized token (first 20 + last 5 chars only)
    âœ… Verify token is valid format after sanitization
    âœ… No breaking changes to existing API

  Code location: __init__ method of RDClient class

  Test:
    - Bot starts and logs: "âœ… Token sanitized: DHC7AHVQUL...2HHA"
    - No "Invalid leading whitespace" errors in logs
    - RealDebrid API calls succeed


ISSUE #2: Restore Missing Command Handlers
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Problem:
  - Bot only responds to /status command
  - Missing handlers for: /sb_list, /sb_download, /rd_list, /rd_torrents, /rss_list, /rss_add, /help, /start
  - Diagnostic version accidentally removed all other handlers

Solution: Update bot/main_bot.py

  Add command handlers (9 total):

    Core Commands:
      âœ… /start - Show welcome message
      âœ… /help - Show available commands
      âœ… /status - Show active downloads/torrents (already exists, keep as-is)

    RealDebrid Commands:
      âœ… /rd_list - List RealDebrid downloads
          - Call: rd_client.get_downloads()
          - Display: List with status, filename, size
          - Format: HTML with emojis (ğŸ“¥ for status, file names bold)

      âœ… /rd_torrents - List RealDebrid torrents
          - Call: rd_client.get_torrents()
          - Display: List with status, progress, filename
          - Format: HTML with emojis

    Seedbox Commands:
      âœ… /sb_list - List seedbox torrents
          - Call: seedbox_client.list_torrents()
          - Display: List with name, size, ratio, status
          - Format: HTML with emojis (ğŸŒ± for seedbox)

      âœ… /sb_download - Add torrent to seedbox
          - Syntax: /sb_download <magnet_link_or_torrent_url>
          - Call: seedbox_client.add_torrent(link)
          - Feedback: Confirmation message or error

    RSS Commands:
      âœ… /rss_list - List configured RSS feeds
          - Call: rss_handler.list_feeds()
          - Display: Feed name, URL, last update
          - Format: HTML with emojis (ğŸ“°)

      âœ… /rss_add - Add new RSS feed
          - Syntax: /rss_add <feed_name> <feed_url>
          - Call: rss_handler.add_feed(name, url)
          - Feedback: Confirmation or error

  Additional Requirements:
    âœ… User authorization checks (only ALLOWED_USER_IDS can use)
    âœ… Comprehensive logging for each command
    âœ… Proper error handling with user-friendly messages
    âœ… HTML formatting with emojis for better UX
    âœ… Timeout handling (API calls may take time)
    âœ… Command context.args parsing for parameters

  Architecture:
    - Create separate handler functions for each command
    - Use async/await for all handlers
    - Proper try-catch for each handler
    - Log every command: "ğŸ“¥ Received /command from user XXXXX"
    - Log responses: "âœ… Sent /command response"

  Test:
    - Send /start â†’ Bot responds
    - Send /help â†’ Bot shows all commands
    - Send /status â†’ Bot shows status (existing)
    - Send /rd_list â†’ Bot lists RD downloads
    - Send /sb_list â†’ Bot lists seedbox torrents
    - Send /rss_list â†’ Bot lists RSS feeds
    - All commands show in logs


ISSUE #3: Seedbox Retry Logic & Resilience
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Problem:
  - 502 Bad Gateway error crashes seedbox commands
  - No retry mechanism
  - Seedbox sometimes unavailable temporarily

Solution: Update bot/clients/seedbox.py

  Add retry logic:
    âœ… Implement exponential backoff: 5s, 10s, 15s
    âœ… Max 3 retry attempts
    âœ… Handle HTTP 502 (Bad Gateway)
    âœ… Handle HTTP 503 (Service Unavailable)
    âœ… Handle connection timeouts (15s timeout)
    âœ… Handle connection errors gracefully

  Resilience features:
    âœ… Cache last successful torrent list
    âœ… Use cache if API fails after retries
    âœ… Log retry attempts: "ğŸ”„ Seedbox connection attempt (1/3)"
    âœ… Log waits: "â³ Waiting 5s before retry..."
    âœ… Log success: "âœ… Successfully connected"

  Code locations:
    - Create new method: _test_connection() with retry logic
    - Create new method: _request_with_retry() for all API calls
    - Update: list_torrents() to use retry logic
    - Update: add_torrent() to use retry logic
    - Update: get_torrent_data() to use retry logic
    - Update: remove_torrent() to use retry logic

  Retry algorithm:
    ```
    for attempt in range(1, max_retries + 1):
        try:
            result = api_call()
            if success:
                return result
            elif 502 or 503:
                if attempt < max_retries:
                    wait_time = 5 * attempt
                    sleep(wait_time)
                    continue
                else:
                    use_cache()
                    return
        except error:
            if attempt < max_retries:
                sleep(5 * attempt)
                continue
            else:
                use_cache()
                return
    ```

  Test:
    - Bot sends /sb_list
    - Logs show: "ğŸ”„ Seedbox connection attempt (1/3)"
    - If 502: Wait 5s, retry
    - If 502 again: Wait 10s, retry
    - Eventually succeeds or uses cache


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

FILE MODIFICATIONS SUMMARY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. bot/main_bot.py
   Lines to add/modify: ~500-700 lines
   Changes:
     - Add 9 command handler functions
     - Register handlers in Application
     - Add comprehensive logging
     - Add authorization checks
     - Add error handling

2. bot/clients/realdebrid.py
   Lines to add/modify: ~20-30 lines
   Changes:
     - Update __init__ method
     - Add token sanitization
     - Add validation logging
     - No changes to API methods

3. bot/clients/seedbox.py
   Lines to add/modify: ~300-400 lines
   Changes:
     - Add _test_connection() method
     - Add _request_with_retry() method
     - Update all API methods to use retry logic
     - Add caching mechanism
     - Update logging throughout


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

TESTING CHECKLIST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Unit Tests (Local):
  [ ] Token sanitization removes \r, \n, \t
  [ ] Token sanitization preserves valid token format
  [ ] Each command handler parses args correctly
  [ ] Authorization checks work correctly
  [ ] Error handling returns proper messages

Integration Tests (Heroku):
  [ ] Bot starts without errors
  [ ] Logs show all handlers registered
  [ ] Logs show token sanitized
  [ ] /start command responds
  [ ] /help command responds with all commands listed
  [ ] /status command works (existing)
  [ ] /rd_list command responds
  [ ] /rd_torrents command responds
  [ ] /sb_list command responds
  [ ] /sb_download command accepts parameters
  [ ] /rss_list command responds
  [ ] /rss_add command accepts parameters
  [ ] Unauthorized users get error
  [ ] Commands timeout gracefully (no 500 errors)
  [ ] Seedbox retry logic logs appear (ğŸ”„ attempts)
  [ ] 502 errors don't crash bot

User Acceptance Tests (Telegram):
  [ ] Send /start â†’ Receive welcome
  [ ] Send /help â†’ Receive command list
  [ ] Send /status â†’ Receive status update
  [ ] Send /rd_list â†’ Receive downloads or empty message
  [ ] Send /sb_list â†’ Receive torrents or empty message
  [ ] All responses formatted properly with emojis
  [ ] No timeout or error messages


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

DEPLOYMENT STEPS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. Create feature branch:
   git checkout -b fix/restore-handlers-and-resilience

2. Make changes to 3 files:
   - bot/main_bot.py
   - bot/clients/realdebrid.py
   - bot/clients/seedbox.py

3. Test locally (if possible):
   - Run linting: flake8 bot/
   - Check imports and syntax
   - Verify no hardcoded values

4. Commit changes:
   git add bot/main_bot.py bot/clients/realdebrid.py bot/clients/seedbox.py
   git commit -m "fix: restore all handlers, sanitize RD token, add seedbox retry logic"

5. Push to GitHub:
   git push origin fix/restore-handlers-and-resilience

6. Create Pull Request
   - Title: "Fix: Restore command handlers, token sanitization, seedbox resilience"
   - Description: List all 3 fixes
   - Link to this plan

7. Deploy to Heroku:
   git push heroku fix/restore-handlers-and-resilience:main

8. Monitor logs:
   heroku logs --tail

9. Verify all tests pass (see Testing Checklist)

10. Merge to main:
    git checkout main
    git merge fix/restore-handlers-and-resilience
    git push origin main


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

REFERENCE FILES PROVIDED
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

These ready-made files are available as reference:

1. main_bot_COMPLETE.py [code_file:185]
   - Complete working bot with all 9 handlers
   - Use as reference for handler implementation
   - Can copy code patterns from this file

2. realdebrid_FIXED.py [code_file:156]
   - Token sanitization implementation
   - Use as reference for token cleanup logic
   - Shows logging pattern

3. seedbox_RESILIENT.py [code_file:187]
   - Complete retry logic implementation
   - Exponential backoff example
   - Error handling patterns
   - Caching mechanism

Guides:
4. DEPLOYMENT_GUIDE_RESTORE_HANDLERS.txt [code_file:186]
5. SUMMARY_ALL_FIXES.txt [code_file:188]
6. QUICK_START.txt [code_file:189]


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

REQUIREMENTS & CONSTRAINTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Must:
  âœ… Fix all 3 issues without breaking existing functionality
  âœ… Maintain backward compatibility with existing code
  âœ… Use existing logging patterns (logger.info, logger.error, etc.)
  âœ… Follow existing code style and conventions
  âœ… Add comprehensive logging for debugging
  âœ… Include proper error handling
  âœ… No hardcoded values (use environment variables)

Should:
  âœ… Make code readable and maintainable
  âœ… Add comments where logic is complex
  âœ… Test each command independently
  âœ… Use the provided reference files as guidance

Don't:
  âŒ Remove any existing functionality
  âŒ Change API signatures of existing methods
  âŒ Use hardcoded credentials or tokens
  âŒ Ignore error cases
  âŒ Skip logging for important events


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ESTIMATED TIMELINE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Task 1: Token Sanitization (30 min)
  - Update realdebrid.py __init__
  - Add logging
  - Test locally

Task 2: Restore Command Handlers (90 min)
  - Implement 9 handler functions
  - Add authorization checks
  - Add error handling
  - Test each command

Task 3: Seedbox Retry Logic (60 min)
  - Implement _request_with_retry()
  - Update all methods to use retry
  - Add caching mechanism
  - Test with 502 errors

Testing & Deployment (30 min)
  - Run all tests
  - Deploy to Heroku
  - Monitor logs
  - Verify with team

Total: ~4.5-5 hours


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

SUCCESS CRITERIA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Bot is considered "fixed" when:

âœ… All 9 commands respond to Telegram messages
âœ… No "Invalid leading whitespace" errors
âœ… Token is sanitized on startup (logs show clean token)
âœ… Seedbox 502 errors don't crash bot (retry logic works)
âœ… All commands logged properly in Heroku logs
âœ… No existing functionality broken
âœ… User authorization working
âœ… Error messages user-friendly
âœ… Response times acceptable (<5 seconds)


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CONTACT POINTS FOR CLARIFICATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

If unclear about:
  - Command output format â†’ Check SUMMARY_ALL_FIXES.txt for examples
  - Logging format â†’ Check existing code in bot/monitor.py
  - Error handling â†’ Check existing handlers in bot/handlers/
  - API methods â†’ Check existing client methods
  - Heroku deployment â†’ Check existing Procfile and requirements.txt


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

DEPENDENCIES & COMPATIBILITY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Python Version: 3.8+
Required Packages:
  - python-telegram-bot (v13)
  - requests
  - aiohttp
  - redis (optional, for state)

No new packages needed for these fixes.
All changes use existing dependencies.


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ROLLBACK PLAN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

If issues occur after deployment:

1. Immediate rollback:
   git revert <commit-hash>
   git push heroku main

2. Quick diagnostics:
   heroku logs --tail | grep ERROR

3. Check specific issues:
   - Token: heroku logs | grep "Token sanitized"
   - Handlers: heroku logs | grep "handlers registered"
   - Seedbox: heroku logs | grep "Seedbox"

4. Restart if needed:
   heroku restart


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
